<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://poorya.me/feed.xml" rel="self" type="application/atom+xml" /><link href="https://poorya.me/" rel="alternate" type="text/html" hreflang="en" /><updated>2023-11-19T14:23:49+00:00</updated><id>https://poorya.me/feed.xml</id><title type="html">blank</title><subtitle>Welcome to my personal website, where I share my passion for technology and my expertise in DevOps. As a DevOps professional, I have a deep understanding of the intersection between software development and IT operations, and I&apos;m always on the lookout for new and innovative ways to optimize and streamline processes. On this website, you&apos;ll find articles and blog posts on a wide range of technology topics, including DevOps best practices, cloud computing, automation, and more. I also share my personal experiences and insights on my journey in the tech industry, and provide updates on the latest trends and innovations in the field. Whether you&apos;re a fellow DevOps enthusiast or simply interested in learning more about technology, I hope you&apos;ll find something here that interests and inspires you. Thank you forvisiting my website!
</subtitle><entry><title type="html">GitOps with Flux!</title><link href="https://poorya.me/blog/2023/gitops-with-flux/" rel="alternate" type="text/html" title="GitOps with Flux!" /><published>2023-04-02T22:12:00+00:00</published><updated>2023-04-02T22:12:00+00:00</updated><id>https://poorya.me/blog/2023/gitops-with-flux</id><content type="html" xml:base="https://poorya.me/blog/2023/gitops-with-flux/"><![CDATA[<p>In this post, we will explore GitOps and how it can be implemented with Flux on a Kubernetes cluster.</p>

<h3 id="what-is-flux">What is Flux?</h3>

<p>Flux is a popular GitOps tool used to manage and automate deployments on Kubernetes clusters. It uses a Git repository as the source of truth for your infrastructure and application configurations.</p>

<h3 id="creating-a-kubernetes-cluster">Creating a Kubernetes Cluster</h3>

<p>For this demo, weâ€™ll be using KinD (Kubernetes IN Docker), which allows you to create a local Kubernetes cluster for development and testing purposes.</p>

<p>First, create a cluster using KinD:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind create cluster --name demo
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating cluster "demo" ...
 âœ“ Ensuring node image (kindest/node:v1.25.3) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-demo"
You can now use your cluster with:

kubectl cluster-info --context kind-demo
</code></pre></div></div>

<p>Once the cluster is created, you can check its info:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl cluster-info --context kind-demo
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Kubernetes control plane is running at https://127.0.0.1:65535
CoreDNS is running at https://127.0.0.1:65535/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.


The cluster is ready!
</code></pre></div></div>

<h3 id="installing-flux-cli">Installing Flux CLI</h3>

<p>To install the Flux CLI, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install fluxcd/tap/flux
</code></pre></div></div>

<h3 id="bootstrap-flux">Bootstrap Flux</h3>

<p>Before we can bootstrap Flux, we need to create a GitHub personal access token. You can create a token with either the <code class="language-plaintext highlighter-rouge">admin:org</code> or <code class="language-plaintext highlighter-rouge">repo</code> permission, depending on whether you need Flux to create a repository or you already have an existing one.</p>

<p>Export the token as an environment variable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export GITHUB_TOKEN=&lt;your-token&gt;
</code></pre></div></div>

<p>Run the bootstrap command to create a repository on your personal GitHub account and configure Flux to sync with it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flux bootstrap github \
  --owner=&lt;your-github-username&gt; \
  --repository=&lt;your-github-repository&gt; \
  --path=clusters/demo \
  --personal
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â–º connecting to github.com
âœ” repository "https://github.com/&lt;your-github-username&gt;/&lt;your-github-repository&gt;" created
â–º cloning branch "main" from Git repository "https://github.com/&lt;your-github-username&gt;/&lt;your-github-repository&gt;.git"
âœ” cloned repository
â–º generating component manifests
âœ” generated component manifests
âœ” committed sync manifests to "main" ("0f908b5013bb6b21c0f6a1b37980a8d85a1dfad2")
â–º pushing component manifests to "https://github.com/&lt;your-github-username&gt;/&lt;your-github-repository&gt;.git"
â–º installing components in "flux-system" namespace
âœ” installed components
âœ” reconciled components
â–º determining if source secret "flux-system/flux-system" exists
â–º generating source secret
âœ” public key: ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzODQAAABhBBOH8h11Rm92kX9XASEtIsuMDu3AqMTIUZV/6DV0N+w6Kb0tgvE3FY0DXqCkbhpSbiqSK5ojMVrpR3WNjqGGE4Bp+gzEthJ/+L3ocajYbIJRP45pTXnVFWT98fvuz0A9WA==
âœ” configured deploy key "flux-system-main-flux-system-./clusters/demo" for "https://github.com/&lt;your-github-username&gt;/&lt;your-github-repository&gt;"
â–º applying source secret "flux-system/flux-system"
âœ” reconciled source secret
â–º generating sync manifests
âœ” generated sync manifests
âœ” committed sync manifests to "main" ("c09327b2fcd9db4ac1d5cbe907425a44658631af")
â–º pushing sync manifests to "https://github.com/&lt;your-github-username&gt;/&lt;your-github-repository&gt;.git"
â–º applying sync manifests
âœ” reconciled sync configuration
â— waiting for Kustomization "flux-system/flux-system" to be reconciled
âœ” Kustomization reconciled successfully
â–º confirming components are healthy
âœ” helm-controller: deployment ready
âœ” kustomize-controller: deployment ready
âœ” notification-controller: deployment ready
âœ” source-controller: deployment ready
âœ” all components are healthy
</code></pre></div></div>

<p>This command will create a private git repository and generate Flux manifests that are committed to the main branch. It will also install the Flux components in the flux-system namespace.
Once the repository has been created and configured, you can clone it locally using the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:&lt;your-github-username&gt;/&lt;your-github-repository&gt;.git
</code></pre></div></div>

<h3 id="directory-structure">Directory Structure</h3>

<p>The directory structure of the repository after Flux is bootstrapped is as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">&lt;your-github-repository&gt;</span>
<span class="s">â””â”€â”€ clusters</span>
    <span class="s">â””â”€â”€ demo</span>
        <span class="s">â””â”€â”€ flux-system</span>
            <span class="s">â”œâ”€â”€ gotk-components.yaml</span>
            <span class="s">â”œâ”€â”€ gotk-sync.yaml</span>
            <span class="s">â””â”€â”€ kustomization.yaml</span>
</code></pre></div></div>

<p>This directory contains the Flux manifests that were generated during the bootstrap process.
Thatâ€™s it! You have now bootstrapped Flux and have a Kubernetes cluster ready for GitOps.
Every file located in the directory <code class="language-plaintext highlighter-rouge">clusters/demo</code> are deployed to your kubernetes cluster because of manifest <code class="language-plaintext highlighter-rouge">gotk-sync.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This manifest was generated by flux. DO NOT EDIT.</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">source.toolkit.fluxcd.io/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">GitRepository</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">1m0s</span>
  <span class="na">ref</span><span class="pi">:</span>
    <span class="na">branch</span><span class="pi">:</span> <span class="s">main</span>
  <span class="na">secretRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
  <span class="na">url</span><span class="pi">:</span> <span class="s">ssh://git@github.com/&lt;your-github-username&gt;/&lt;your-github-repository&gt;</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.toolkit.fluxcd.io/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">10m0s</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">./clusters/demo</span>
  <span class="na">prune</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">sourceRef</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">GitRepository</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
</code></pre></div></div>

<p>This file contains two manifests, <code class="language-plaintext highlighter-rouge">GitRepository</code> and <code class="language-plaintext highlighter-rouge">Kustomization</code>. The <code class="language-plaintext highlighter-rouge">Kustomization</code> manifest references the <code class="language-plaintext highlighter-rouge">GitRepository</code> on the path <code class="language-plaintext highlighter-rouge">./clusters/demo</code>.
This <code class="language-plaintext highlighter-rouge">Kustomization</code> manifest has an interval of 10 minutes which Flux named Reconcile.
Now letâ€™s give this directory a good structure.</p>

<h3 id="how-to-do-it">How to do it</h3>

<p>Create the following three manifests in the path of your cluster:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">clusters/demo/repositories.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.toolkit.fluxcd.io/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">repositories</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">3m</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">./repositories</span>
  <span class="na">prune</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">sourceRef</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">GitRepository</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">clusters/demo/infrastructure.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.toolkit.fluxcd.io/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">infrastructure</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">3m</span>
  <span class="na">dependsOn</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">repositories</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">./deploy/infrastructure/overlays/demo</span>
  <span class="na">prune</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">sourceRef</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">GitRepository</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">clusters/demo/applications.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.toolkit.fluxcd.io/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">applications</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">3m</span>
  <span class="na">dependsOn</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">infrastructure</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">./deploy/applications/overlays/demo</span>
  <span class="na">prune</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">sourceRef</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">GitRepository</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">flux-system</span>
</code></pre></div></div>

<p>As you can see, those three <code class="language-plaintext highlighter-rouge">Kustomization</code> have paths and dependencies on each other. Letâ€™s create directories:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;your-github-repository&gt;
â”œâ”€â”€ clusters
â”‚   â””â”€â”€ demo
â”‚       â”œâ”€â”€ applications.yaml
â”‚       â”œâ”€â”€ flux-system
â”‚       â”‚   â”œâ”€â”€ gotk-components.yaml
â”‚       â”‚   â”œâ”€â”€ gotk-sync.yaml
â”‚       â”‚   â””â”€â”€ kustomization.yaml
â”‚       â”œâ”€â”€ infrastructure.yaml
â”‚       â””â”€â”€ repositories.yaml
â”œâ”€â”€ deploy
â”‚   â”œâ”€â”€ applications
â”‚   â”‚   â””â”€â”€ overlays
â”‚   â”‚       â””â”€â”€ demo
â”‚   â””â”€â”€ infrastructure
â”‚       â””â”€â”€ overlays
â”‚           â””â”€â”€ demo
â””â”€â”€ repositories
</code></pre></div></div>

<p>Create all the necessary repositories in the <code class="language-plaintext highlighter-rouge">repositories</code> directory. For example:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">repositories/bitnami.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">source.toolkit.fluxcd.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRepository</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">bitnami</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">720h</span>
  <span class="na">timeout</span><span class="pi">:</span> <span class="s">5m</span>
  <span class="na">url</span><span class="pi">:</span> <span class="s">https://charts.bitnami.com/bitnami</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">repositories/banzaicloud.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">source.toolkit.fluxcd.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRepository</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">banzaicloud</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">720h</span>
  <span class="na">timeout</span><span class="pi">:</span> <span class="s">5m</span>
  <span class="na">url</span><span class="pi">:</span> <span class="s">https://kubernetes-charts.banzaicloud.com</span>
</code></pre></div></div>

<p>We can use these repositories to deploy infrastructure or applications. Letâ€™s create our infrastructure stack for two environments, production and staging.
Since we do not want to repeat the code for every cluster and environment, we can use the <code class="language-plaintext highlighter-rouge">base</code> directory in the infrastructure and application directories.
Create the following files to deploy MySQL:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/base/mysql/helm-release.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">helm.toolkit.fluxcd.io/v2beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRelease</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">720h</span>
  <span class="na">chart</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">chart</span><span class="pi">:</span> <span class="s">mysql</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">9.4.5'</span>
      <span class="na">sourceRef</span><span class="pi">:</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRepository</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">bitnami</span>
        <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">720h</span>
  <span class="na">upgrade</span><span class="pi">:</span>
    <span class="na">remediation</span><span class="pi">:</span>
      <span class="na">remediateLastFailure</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">values</span><span class="pi">:</span>
  <span class="na">valuesFrom</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-values</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-values-overrides</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/base/mysql/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">helm-release.yaml</span>
<span class="na">configMapGenerator</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-values</span>
    <span class="na">files</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">values.yaml=values.yaml</span>
<span class="na">configurations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">kustomizeconfig.yaml</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/base/mysql/kustomizeconfig.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">nameReference</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">fieldSpecs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">spec/valuesFrom/name</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRelease</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/base/mysql/values.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">fullnameOverride</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">architecture</span><span class="pi">:</span> <span class="s">standalone</span>
<span class="na">auth</span><span class="pi">:</span>
  <span class="na">rootPassword</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo"</span>
  <span class="na">createDatabase</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo"</span>
</code></pre></div></div>

<p>Now we are ready to use this base in the overlay directory by addressing this directory and overriding the Helm value for every deployment. For this to be done, we need to create namespaces for production and staging. Create the following files in the infrastructure overlays directory:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/production/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">namespace.yaml</span>
  <span class="pi">-</span> <span class="s">mysql</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/production/namespace.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">production</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/production/mysql/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../../../../base/mysql</span>
<span class="na">configMapGenerator</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-values-overrides</span>
  <span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">values-overrides.yaml=values.yaml</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/production/mysql/values-overrides.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">auth</span><span class="pi">:</span>
  <span class="na">rootPassword</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo-prod"</span>
  <span class="na">createDatabase</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo-prod"</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/staging/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">staging</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">namespace.yaml</span>
  <span class="pi">-</span> <span class="s">mysql</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/staging/namespace.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">staging</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/staging/mysql/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../../../../base/mysql</span>
<span class="na">configMapGenerator</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-values-overrides</span>
  <span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">values-overrides.yaml=values.yaml</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/infrastructure/overlays/demo/staging/mysql/values-overrides.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">auth</span><span class="pi">:</span>
  <span class="na">rootPassword</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo-stag"</span>
  <span class="na">createDatabase</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo-stag"</span>
</code></pre></div></div>

<p>Now that the infrastructure part is complete, we can deploy Drupal to the <code class="language-plaintext highlighter-rouge">applications</code> directory, same as <code class="language-plaintext highlighter-rouge">infrastructure</code>, with the help of base. Create the
following files:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/base/drupal/helm-release.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">helm.toolkit.fluxcd.io/v2beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRelease</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">drupal</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">interval</span><span class="pi">:</span> <span class="s">720h</span>
  <span class="na">chart</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">chart</span><span class="pi">:</span> <span class="s">drupal</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">13.0.9'</span>
      <span class="na">sourceRef</span><span class="pi">:</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRepository</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">bitnami</span>
        <span class="na">namespace</span><span class="pi">:</span> <span class="s">flux-system</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">720h</span>
  <span class="na">upgrade</span><span class="pi">:</span>
    <span class="na">remediation</span><span class="pi">:</span>
      <span class="na">remediateLastFailure</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">values</span><span class="pi">:</span>
  <span class="na">valuesFrom</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">drupal-values</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">drupal-values-overrides</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/base/drupal/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">helm-release.yaml</span>
<span class="na">configMapGenerator</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">drupal-values</span>
    <span class="na">files</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">values.yaml=values.yaml</span>
<span class="na">configurations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">kustomizeconfig.yaml</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/base/drupal/kustomizeconfig.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">nameReference</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">fieldSpecs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">spec/valuesFrom/name</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">HelmRelease</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/base/drupal/values.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">fullnameOverride</span><span class="pi">:</span> <span class="s">drupal</span>
<span class="na">persistence</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">false</span>
<span class="na">mariadb</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">false</span>
<span class="na">externalDatabase</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">bn_drupal</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">bitnami_drupal</span>
<span class="na">drupalPassword</span><span class="pi">:</span> <span class="s">demo</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/overlays/demo/production/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">drupal</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/overlays/demo/production/drupal/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../../../../base/drupal</span>
<span class="na">configMapGenerator</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">drupal-values-overrides</span>
  <span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">values.yaml=values-overrides.yaml</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/overlays/demo/production/drupal/values-overrides.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">fullnameOverride</span><span class="pi">:</span> <span class="s">drupal-prod</span>
<span class="na">externalDatabase</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">demo-prod</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">demo-prod</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/overlays/demo/staging/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">staging</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">drupal</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/overlays/demo/staging/drupal/kustomization.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../../../../base/drupal</span>
<span class="na">configMapGenerator</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">drupal-values-overrides</span>
  <span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">values.yaml=values-overrides.yaml</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy/applications/overlays/demo/staging/drupal/values-overrides.yaml</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">fullnameOverride</span><span class="pi">:</span> <span class="s">drupal-stag</span>
<span class="na">externalDatabase</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">demo-stag</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">demo-stag</span>
</code></pre></div></div>

<p>The final look of the directory should be like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitops
â”œâ”€â”€ clusters
â”‚   â””â”€â”€ demo
â”‚       â”œâ”€â”€ applications.yaml
â”‚       â”œâ”€â”€ flux-system
â”‚       â”‚   â”œâ”€â”€ gotk-components.yaml
â”‚       â”‚   â”œâ”€â”€ gotk-sync.yaml
â”‚       â”‚   â””â”€â”€ kustomization.yaml
â”‚       â”œâ”€â”€ infrastructure.yaml
â”‚       â””â”€â”€ repositories.yaml
â”œâ”€â”€ deploy
â”‚   â”œâ”€â”€ applications
â”‚   â”‚   â”œâ”€â”€ base
â”‚   â”‚   â”‚   â””â”€â”€ drupal
â”‚   â”‚   â”‚       â”œâ”€â”€ helm-release.yaml
â”‚   â”‚   â”‚       â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”‚       â”œâ”€â”€ kustomizeconfig.yaml
â”‚   â”‚   â”‚       â””â”€â”€ values.yaml
â”‚   â”‚   â””â”€â”€ overlays
â”‚   â”‚       â””â”€â”€ demo
â”‚   â”‚           â”œâ”€â”€ production
â”‚   â”‚           â”‚   â”œâ”€â”€ drupal
â”‚   â”‚           â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚           â”‚   â”‚   â””â”€â”€ values-overrides.yaml
â”‚   â”‚           â”‚   â””â”€â”€ kustomization.yaml
â”‚   â”‚           â””â”€â”€ staging
â”‚   â”‚               â”œâ”€â”€ drupal
â”‚   â”‚               â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚               â”‚   â””â”€â”€ values-overrides.yaml
â”‚   â”‚               â””â”€â”€ kustomization.yaml
â”‚   â””â”€â”€ infrastructure
â”‚       â”œâ”€â”€ base
â”‚       â”‚   â””â”€â”€ mysql
â”‚       â”‚       â”œâ”€â”€ helm-release.yaml
â”‚       â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â”‚       â”œâ”€â”€ kustomizeconfig.yaml
â”‚       â”‚       â””â”€â”€ values.yaml
â”‚       â””â”€â”€ overlays
â”‚           â””â”€â”€ demo
â”‚               â”œâ”€â”€ production
â”‚               â”‚   â”œâ”€â”€ kustomization.yaml
â”‚               â”‚   â”œâ”€â”€ mysql
â”‚               â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚               â”‚   â”‚   â””â”€â”€ values-overrides.yaml
â”‚               â”‚   â””â”€â”€ namespace.yaml
â”‚               â””â”€â”€ staging
â”‚                   â”œâ”€â”€ kustomization.yaml
â”‚                   â”œâ”€â”€ mysql
â”‚                   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚                   â”‚   â””â”€â”€ values-overrides.yaml
â”‚                   â””â”€â”€ namespace.yaml
â””â”€â”€ repositories
    â”œâ”€â”€ banzaicloud.yaml
    â””â”€â”€ bitnami.yaml
</code></pre></div></div>

<p>We need to push our code and wait a couple of minutes for Flux to reconcile the repository and deploy everything to the Kubernetes cluster. We can also force
reconcile with the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flux reconcile kustomization repositories <span class="nt">--with-source</span>
</code></pre></div></div>

<p>You can access the full code repository here: https://github.com/pooryasheikh/gitops</p>

<h3 id="to-do">To-do</h3>

<ul>
  <li>Configure image auto-update</li>
  <li>Configure Sops</li>
  <li>Add HashiCorp Vault to the cluster and read secrets with an init container</li>
  <li>Create a common Helm chart and use it as a HelmGitRepository</li>
</ul>]]></content><author><name></name></author><category term="gitops" /><category term="gitops" /><category term="flux" /><category term="kubernetes" /><category term="devops" /><summary type="html"><![CDATA[Learn how to streamline your infrastructure deployment with GitOps and Flux.]]></summary></entry></feed>